{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
  <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-6">
    네이버 블로그 분석 &amp; 개선안
  </h1>

  <div class="grid gap-8 grid-cols-1">
    <!-- 왼쪽: 입력 폼 -->
    <div>
      <div class="bg-white shadow-sm rounded-xl border border-slate-200 p-6 space-y-4">
        <h2 class="text-lg font-semibold text-slate-800">분석 대상 입력</h2>
        <p class="text-sm text-slate-500">
          네이버 블로그 게시물 URL과 핵심 키워드를 입력하면,<br />
          상위노출 기준에 따라 구조/키워드/규제 관점에서 진단하고 개선안을 제안합니다.
        </p>

        <form id="improvement-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">회사이름</label>
              <input
                type="text"
                name="company_name"
                id="company_name"
                class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="예: BAT"
              />
            </div>
          
            <div>
              <label class="block text-sm font-medium text-gray-700">이름</label>
              <input
                type="text"
                name="contact_name"
                id="contact_name"
                class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="예: 소재민"
              />
            </div>
          
            <div>
              <label class="block text-sm font-medium text-gray-700">연락처</label>
              <input
                type="text"
                name="phone"
                id="phone"
                class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="예: 010-1234-5678"
              />
            </div>
          
            <div>
              <label class="block text-sm font-medium text-gray-700">이메일</label>
              <input
                type="email"
                name="email"
                id="email"
                class="mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="예: test@example.com"
              />
            </div>
          </div>

          <div>
            <label for="blog_url" class="block text-sm font-medium text-slate-700 mb-1">
              네이버 블로그 URL
            </label>
            <input
              id="blog_url"
              name="blog_url"
              type="url"
              required
              placeholder="https://blog.naver.com/..."
              class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"
            />
          </div>

          <div>
            <label for="core_keyword" class="block text-sm font-medium text-slate-700 mb-1">
              핵심 키워드
            </label>
            <input
              id="core_keyword"
              name="core_keyword"
              type="text"
              required
              placeholder="예: L-PDRN 앰플, 수분크림, 탄력케어 등"
              class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 text-sm"
            />
          </div>

          <div class="flex items-center justify-between pt-2">
            <p class="text-xs text-slate-500">
              * URL의 본문을 크롤링해 상위노출 기준으로 점검합니다.
            </p>
            <button
              type="submit"
              id="improvement-submit"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:opacity-60"
            >
              분석 시작하기
            </button>
          </div>
        </form>

        <p id="improvement-error" class="mt-2 text-sm text-red-500 hidden"></p>
      </div>
    </div>

    <!-- 오른쪽: 결과 영역 -->
    <div>
      <div class="bg-slate-900 rounded-xl shadow-inner p-4 sm:p-5 h-full flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-sm font-semibold text-slate-100">분석 결과</h2>
            <p class="text-[11px] text-slate-400 mt-0.5">JSON 기반 UI(점수/우선순위/체크리스트)로 표시됩니다. 필요 시 원문도 함께 제공합니다.</p>
          </div>
          <span
            id="improvement-status"
            class="text-xs text-slate-400"
          >
            URL과 키워드를 입력 후 분석을 시작하세요.
          </span>
        </div>

        <div class="flex-1 rounded-lg bg-slate-950/70 border border-slate-800 p-3 overflow-auto">
          <!-- Structured (JSON) UI -->
          <div id="improvement-result-ui" class="hidden space-y-4"></div>

          <!-- Raw fallback text (Markdown/Plain) -->
          <pre
            id="improvement-result-raw"
            class="hidden text-xs sm:text-sm font-mono text-slate-100 whitespace-pre-wrap"
          ></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById("improvement-form");
  const submitBtn = document.getElementById("improvement-submit");
  const resultUIEl = document.getElementById("improvement-result-ui");
  const resultRawEl = document.getElementById("improvement-result-raw");
  const statusEl = document.getElementById("improvement-status");
  const errorEl = document.getElementById("improvement-error");

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function badge(sev) {
    const s = (sev || "").toLowerCase();
    if (s === "high") return "bg-rose-600/15 text-rose-300 border-rose-600/30";
    if (s === "medium") return "bg-amber-600/15 text-amber-300 border-amber-600/30";
    return "bg-emerald-600/15 text-emerald-300 border-emerald-600/30";
  }

  function scoreBar(score) {
    const v = Math.max(0, Math.min(100, Number(score || 0)));
    return `
      <div class="mt-2 h-2 rounded bg-slate-800 overflow-hidden">
        <div class="h-2 rounded bg-sky-500" style="width:${v}%"></div>
      </div>
    `;
  }

  function renderAnalysisUI(j) {
    // Summary + scores
    const summary = escapeHtml(j.summary || "");
    const scores = j.scores || {};

    const scoreCards = [
      { key: "seo", label: "SEO" },
      { key: "readability", label: "가독성" },
      { key: "structure", label: "구조" },
      { key: "keyword", label: "키워드" },
    ].map(({ key, label }) => {
      const v = Number(scores?.[key] ?? 0);
      return `
        <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-3">
          <div class="flex items-center justify-between">
            <div class="text-xs text-slate-300">${label}</div>
            <div class="text-sm font-semibold text-slate-100">${isFinite(v) ? v : 0}</div>
          </div>
          ${scoreBar(v)}
        </div>
      `;
    }).join("");

    // Issues (priority)
    const issues = Array.isArray(j.issues) ? j.issues : [];
    const issuesHtml = issues.length
      ? issues
          .slice(0, 20)
          .map((it, idx) => {
            const sev = (it.severity || "low").toLowerCase();
            return `
              <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-3 space-y-2">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="text-sm font-semibold text-slate-100">${idx + 1}. ${escapeHtml(it.title || "이슈")}</div>
                    ${it.evidence ? `<div class="text-xs text-slate-400 mt-1">근거: ${escapeHtml(it.evidence)}</div>` : ""}
                  </div>
                  <span class="shrink-0 inline-flex items-center px-2 py-0.5 rounded-full border text-[11px] ${badge(sev)}">${sev.toUpperCase()}</span>
                </div>
                ${it.impact ? `<div class="text-xs text-slate-200"><span class="text-slate-400">영향</span> · ${escapeHtml(it.impact)}</div>` : ""}
                ${it.fix ? `<div class="text-xs text-slate-200"><span class="text-slate-400">개선</span> · ${escapeHtml(it.fix)}</div>` : ""}
              </div>
            `;
          })
          .join("")
      : `<div class="text-xs text-slate-400">이슈 목록이 비어 있습니다.</div>`;

    // Plan / outline / FAQ / Videos / Checklist
    const plan = Array.isArray(j.rewrite_plan) ? j.rewrite_plan : [];
    const outline = Array.isArray(j.suggested_outline) ? j.suggested_outline : [];
    const faq = Array.isArray(j.faq) ? j.faq : [];
    const videos = Array.isArray(j.video_slots) ? j.video_slots : [];
    const checklist = Array.isArray(j.final_checklist) ? j.final_checklist : [];

    const listHtml = (arr) =>
      arr.length
        ? `<ul class="list-disc pl-5 space-y-1 text-xs text-slate-200">${arr
            .slice(0, 20)
            .map((x) => `<li>${escapeHtml(x)}</li>`)
            .join("")}</ul>`
        : `<div class="text-xs text-slate-400">항목이 없습니다.</div>`;

    const faqHtml = faq.length
      ? `<div class="space-y-2">${faq
          .slice(0, 10)
          .map((x) => {
            const q = escapeHtml(x.q || "");
            const a = escapeHtml(x.a || "");
            return `
              <div class="rounded-lg border border-slate-800 bg-slate-950/40 p-3">
                <div class="text-xs text-slate-300"><span class="font-semibold text-slate-100">Q.</span> ${q}</div>
                <div class="text-xs text-slate-200 mt-2"><span class="font-semibold text-slate-100">A.</span> ${a}</div>
              </div>
            `;
          })
          .join("")}</div>`
      : `<div class="text-xs text-slate-400">FAQ가 없습니다.</div>`;

    const videosHtml = videos.length
      ? `<ul class="space-y-2">${videos
          .slice(0, 10)
          .map((x) => `
            <li class="rounded-lg border border-slate-800 bg-slate-950/40 p-3 text-xs text-slate-200">
              <span class="text-slate-400">영상 추천</span> · ${escapeHtml(x)}
            </li>
          `)
          .join("")}</ul>`
      : `<div class="text-xs text-slate-400">영상 슬롯 제안이 없습니다.</div>`;

    const checklistHtml = checklist.length
      ? `<div class="grid gap-2">${checklist
          .slice(0, 30)
          .map((x, i) => `
            <label class="flex items-start gap-2 rounded-lg border border-slate-800 bg-slate-950/40 p-3">
              <input type="checkbox" class="mt-0.5" />
              <span class="text-xs text-slate-200">${escapeHtml(x)}</span>
            </label>
          `)
          .join("")}</div>`
      : `<div class="text-xs text-slate-400">체크리스트가 없습니다.</div>`;

    // Metrics small chips
    const m = j.metrics || {};
    const chips = [
      ["문단수(추정)", m.estimated_paragraphs],
      ["단어수(추정)", m.estimated_words],
      ["서론 키워드", m.intro_has_keyword],
      ["서론 제품/브랜딩", m.intro_has_brand_or_product],
      ["FAQ", m.faq_count],
      ["VIDEO", m.video_slot_count],
    ]
      .filter(([_, v]) => v !== undefined && v !== null)
      .map(([k, v]) => {
        const val = typeof v === "boolean" ? (v ? "OK" : "NO") : String(v);
        const ok = v === true || (typeof v === "number" && v > 0);
        const cls = ok ? "border-emerald-600/30 bg-emerald-600/10 text-emerald-200" : "border-slate-700 bg-slate-900/40 text-slate-200";
        return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full border text-[11px] ${cls}"><span class="text-slate-400">${escapeHtml(k)}</span>${escapeHtml(val)}</span>`;
      })
      .join(" ");

    resultUIEl.innerHTML = `
      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-xs text-slate-400">요약</div>
            <div class="text-sm font-semibold text-slate-100 mt-1">${summary || "요약이 없습니다."}</div>
          </div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">${chips || ""}</div>
        <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">${scoreCards}</div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-slate-100">우선순위 이슈</h3>
          <span class="text-[11px] text-slate-400">HIGH → MEDIUM → LOW</span>
        </div>
        <div class="space-y-3">${issuesHtml}</div>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
          <h3 class="text-sm font-semibold text-slate-100">개선 적용 순서</h3>
          <div class="mt-2">${listHtml(plan)}</div>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
          <h3 class="text-sm font-semibold text-slate-100">추천 구조(목차)</h3>
          <div class="mt-2">${listHtml(outline)}</div>
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
          <h3 class="text-sm font-semibold text-slate-100">FAQ 제안</h3>
          <div class="mt-2">${faqHtml}</div>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
          <h3 class="text-sm font-semibold text-slate-100">VIDEO 슬롯 제안</h3>
          <div class="mt-2">${videosHtml}</div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
        <h3 class="text-sm font-semibold text-slate-100">최종 체크리스트</h3>
        <div class="mt-2">${checklistHtml}</div>
      </div>

      <details class="rounded-xl border border-slate-800 bg-slate-950/40 p-4">
        <summary class="cursor-pointer text-sm font-semibold text-slate-100">원문 결과 보기(폴백)</summary>
        <p class="mt-2 text-xs text-slate-400">아래는 모델 원문 출력입니다. JSON 파싱/디버깅용으로 보관합니다.</p>
      </details>
    `;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorEl.classList.add("hidden");
    errorEl.textContent = "";

    const formData = new FormData(form);

    submitBtn.disabled = true;
    submitBtn.textContent = "분석 중...";
    statusEl.textContent = "Gemini가 블로그를 분석하는 중입니다...";
    resultUIEl.innerHTML = "";
    resultUIEl.classList.add("hidden");
    resultRawEl.textContent = "";
    resultRawEl.classList.add("hidden");

    try {
      const res = await fetch("/improvement", {
        method: "POST",
        body: formData,
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || "분석 중 알 수 없는 오류가 발생했습니다.");
      }

      const analysisJson = data.analysis_json;
      const analysisRaw = data.analysis || "";

      if (analysisJson && typeof analysisJson === "object") {
        renderAnalysisUI(analysisJson);
        resultUIEl.classList.remove("hidden");

        // 원문도 접을 수 있게 같이 제공
        if (analysisRaw.trim().length > 0) {
          resultRawEl.textContent = analysisRaw;
          resultRawEl.classList.remove("hidden");
        }

        statusEl.textContent = "분석 완료. 카드 형태로 확인하세요.";
      } else {
        // JSON이 없으면 기존처럼 원문만 표시
        resultRawEl.textContent = analysisRaw;
        resultRawEl.classList.remove("hidden");
        statusEl.textContent = "분석 완료. 원문 결과를 확인하세요.";
      }
    } catch (err) {
      console.error(err);
      errorEl.textContent = err.message || "분석에 실패했습니다.";
      errorEl.classList.remove("hidden");
      statusEl.textContent = "오류가 발생했습니다. 다시 시도해보세요.";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "분석 시작하기";
    }
  });
</script>
{% endblock %}